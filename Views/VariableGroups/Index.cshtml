@using orchestrator_portal.Dto
@model VariableGroupVm

@{
    var i = 1;
}

<h2>Variable groups</h2>

<ul class="info-list">
    <li> * Its posible to use variable like $project or $subscriptions[i] to reference inputs</li>
</ul>
<hr />
<button type="button" id="addResourceBtn" class="action-btn">
    Add Variable group
</button>

<table class="major-modification" style="width:100%">
    <tbody>
        @foreach (var item in Model.VariableGroup)
        {
        <tr>
            <td style="width:14px"> @i * </td>
            <td> 
                <table id="variable-group-@item.Id" style="width:100%" >
                    <tr>
                        <td>
                            <table class=" table table-striped table-dark-editable" >
                                <tbody>
                                    <tr>
                                        <input type="hidden" name="VariableGroupId" value="@item.Id" />
                                        <td style="width: 200px">
                                            Variable group name
                                        </td>
                                        <td>
                                            <input type="text"
                                                   name="Name"
                                                   value="@item.Name"
                                                   class="form-control" />

                                        </td>
                                        <td style="width:200px">Description</td>
                                        <td>
                                                <input type="text" name="Description" value="@item.Description" class="form-control" />
                                        </td>
                                        <td class="td-button">
                                                <button type="submit" class="action-btn vargroupsaveRowBtn" data-vargroupid="@item.Id">Update</button>
                                        </td>
                                        <td class="td-button">
                                            <button type="submit" class="action-btn vargroupsremoveRowBtn" data-vargroupid="@item.Id">X</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <table class="tomodify-@item.Id table table-striped table-dark-editable">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var assoc in Model.VariableGroupsAssociation.Where(a => a.VariableGroupId == item.Id))
                        {
                            <tr>
                                <input type="hidden" name="AssocId" value="@assoc.Id" />
                                <input type="hidden" name="vargroupId" value="@item.Id" />
                                <td>
                                    <input type="text"
                                            name="AssocKey"
                                            class="form-control"
                                            value="@assoc.Key" />
                                </td>
                                <td>
                                    <input type="text"
                                            name="AssocValue"
                                            class="form-control"
                                            value="@assoc.Value" />
                                </td>
                                <td class="td-button">
                                    <button type="submit" class="action-btn saveRowBtn" data-id="@assoc.Id" data-vargroupid="@item.Id">Update</button>
                                </td>
                                <td class="td-button">
                                    <button type="submit" class="action-btn removeRowBtn" data-id="@assoc.Id" data-vargroupid="@item.Id">X</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </td>
        </tr>
        <tr>
            <td></td>
            <td> 
                <button type="submit" class="action-btn addkeyRowBtn" data-vargroupid="@item.Id">Add Key</button>
                <button type="submit" class="action-btn clonekeyRowBtn" data-vargroupid="@item.Id">Clone All</button>
            </td>
        </tr>
            i++;
        }
    </tbody>
</table>

<table style="display:none">
    <tbody id="variable-group-template">
        <tr>
            <td style="width:14px">*</td>
            <td>
                <table style="width:100%">
                    <tr>
                        <td>
                            <table class="table table-striped table-dark-editable">
                                <tbody>
                                    <tr>
                                        <input type="hidden" name="VariableGroupId" value="0" />
                                        <td style="width:200px">Variable group </td>
                                        <td>
                                            <input type="text" name="Name" class="form-control" value="" />
                                        </td>
                                        <td style="width:200px">Description</td>
                                        <td>
                                            <input type="text" name="Description" class="form-control" value="" />
                                        </td>
                                        <td class="td-button">
                                            <button type="submit"
                                                    class="action-btn vargroupsaveRowBtn"
                                                    data-vargroupid="0">
                                                Save
                                            </button>
                                        </td>
                                        <td class="td-button">
                                            <button type="submit"
                                                    class="action-btn vargroupsCancelRowBtn"
                                                    data-vargroupid="0">
                                                X
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>

        <tr>
            <td></td>
            <td>
                <table class="table table-striped table-dark-editable">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </td>
        </tr>
    </tbody>
</table>


<table style="display:none">
    <tbody>
        <tr id="resource-row-template">
            <input type="hidden" name="AssocId" value="0" />
            <input type="hidden" name="vargroupId" value="0" />
            <td>
                <input type="text"
                       name="AssocKey"
                       class="form-control"
                       value="" />
            </td>
            <td>
                <input type="text"
                       name="AssocValue"
                       class="form-control"
                       value="" />
            </td>
            <td class="td-button">
                <button type="submit" class="action-btn saveRowBtn">Save</button>
            </td>
            <td class="td-button">
                <button type="button" class="action-btn CancelRowBtn">X</button>

            </td>
        </tr>
    </tbody>
</table>


<script>
    $(document).ready(function () {

         $(document).on('click', '.removeRowBtn', function () {
            const $row = $(this).closest('tr');

             const payload = {
                Id : $row.find('input[name="AssocId"]').val()
            };

            $.ajax({
                url: '/variablegroup/association/Delete',
                type: 'POST',
                data: payload,
                success: function () {
                    //alert('Saved!');
                    location.reload();
                },
                error: function () {
                    //alert('Save failed');
                }
            });
         })


        $('.clonekeyRowBtn').on('click', function () {
            selectvargroupid=$(this).data("vargroupid");
                const payload = {
                Id : selectvargroupid
            };

            $.ajax({
                url: '/variablegroup/Clone',
                type: 'POST',
                data: payload,
                success: function () {
                    //alert('Saved!');
                    location.reload();
                },
                error: function () {
                    //alert('Save failed');
                }
            });
        });

        $('.vargroupsremoveRowBtn').on('click', function () {
            selectvargroupid=$(this).data("vargroupid");

            const payload = {
                Id : selectvargroupid
            };

            $.ajax({
                url: '/variablegroup/Delete',
                type: 'POST',
                data: payload,
                success: function () {
                    //alert('Saved!');
                    location.reload();
                },
                error: function () {
                    //alert('Save failed');
                }
            });
        });

        $('.addkeyRowBtn').on('click', function () {
            const $template = $('#resource-row-template').clone();
            selectvargroupid=$(this).data("vargroupid");
            $template.removeAttr('id');
            $template.show();

            $template.find('input[name="vargroupId"]').val(selectvargroupid);

            $(`table.tomodify-${selectvargroupid} tbody`).append($template);

            $(this).prop('disabled', true);
            $('#UpdateAllBtn').prop('disabled', true);
        });

        $('#addResourceBtn').on('click', function () {

            const newId = 0; // temporary (backend will assign real ID)

            // clone ONLY the rows
            const $rows = $('#variable-group-template')
                .children('tr')
                .clone(true);

            $('table.major-modification > tbody').append($rows);
            $(this).prop('disabled', true);
            $('#UpdateAllBtn').prop('disabled', true);
        });

        $(document).on('click', '.vargroupsCancelRowBtn', function () {
            location.reload();
        })

        $(document).on('click', '.vargroupsaveRowBtn', function () {
            const $row = $(this).closest('tr');
            const VariableGroupId = $row.find('input[name="VariableGroupId"]').val();
            const Name = $row.find('input[name="Name"]').val();
            const Description = $row.find('input[name="Description"]').val();

            if (!Name || !Description) {
                Swal.fire({
                    title: 'Missing information',
                    text: 'Please fill in all fields before updating.',
                    icon: 'warning',
                    background: '#2f2f2f',
                    color: '#fff',
                    showConfirmButton: false,
                    timer: 2000
                });
                return;
            }

            const payload = {
                Id: VariableGroupId,
                Name: Name,
                Description: Description
            };

            $.ajax({
                url: '/variablegroup/Save',
                type: 'POST',
                data: payload,
                success: function () {
                    //alert('Saved!');
                    location.reload();
                },
                error: function () {
                    //alert('Save failed');
                    Swal.fire({
                        title: 'Duplicate Value',
                        text: 'Name already exists.',
                        icon: 'error',
                        background: '#2f2f2f',
                        color: '#fff',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            });       
        })

        $(document).on('click', '.CancelRowBtn', function () {
            location.reload();
        })

        $(document).on('click', '.saveRowBtn', function () {
            const $row = $(this).closest('tr');

            const AssocKey = $row.find('input[name="AssocKey"]').val();
            const AssocValue = $row.find('input[name="AssocValue"]').val();
            const selectvargroupid = $row.find('input[name="vargroupId"]').val();
            const AssocId = $row.find('input[name="AssocId"]').val();

            if (!AssocKey || !AssocValue || !selectvargroupid || !AssocId) {
                Swal.fire({
                    title: 'Missing information',
                    text: 'Please fill in all fields before updating.',
                    icon: 'warning',
                    background: '#2f2f2f',
                    color: '#fff',
                    showConfirmButton: false,
                    timer: 2000
                });
                return;
            }

            const payload = {
                Id : AssocId,
                VariableGroupId: selectvargroupid,
                Key: AssocKey,
                Value: AssocValue
            };

            $.ajax({
                url: '/variablegroup/association/Save',
                type: 'POST',
                data: payload,
                success: function () {
                    //alert('Saved!');
                    location.reload();
                },
                error: function () {
                    //alert('Save failed');
                    Swal.fire({
                        title: 'Duplicate Value',
                        text: 'Name already exists.',
                        icon: 'error',
                        background: '#2f2f2f',
                        color: '#fff',
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            });
        });
    })
</script>
